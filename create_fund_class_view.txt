CREATE VIEW fund_class_view AS
SELECT 
    product_code AS product_code,
    asset_class->>'fundShreClsName' AS fund_class_name,
    prod_alt_num_segment->>'prodAltNum' AS fund_class_fund_code
FROM 
    fund_other_fund_classes
    LEFT JOIN LATERAL (
        SELECT asset_class
        FROM jsonb_array_elements(
            CASE 
                WHEN response_data->'assetClasses' IS NULL THEN '[]'::jsonb
                WHEN jsonb_typeof(response_data->'assetClasses') = 'array' THEN response_data->'assetClasses'
                ELSE '[]'::jsonb
            END
        ) AS asset_class
    ) AS ac ON true
    LEFT JOIN LATERAL (
        SELECT prod_alt_num_segment
        FROM jsonb_array_elements(
            CASE 
                WHEN ac.asset_class->'prodAltNumSegs' IS NULL THEN '[]'::jsonb
                WHEN jsonb_typeof(ac.asset_class->'prodAltNumSegs') = 'array' THEN ac.asset_class->'prodAltNumSegs'
                ELSE '[]'::jsonb
            END
        ) AS prod_alt_num_segment
        WHERE prod_alt_num_segment->>'prodCdeAltClassCde' = 'M'
    ) AS pans ON true
WHERE 
    response_data IS NOT NULL
    AND ac.asset_class IS NOT NULL
    AND asset_class->>'fundShreClsName' IS NOT NULL;